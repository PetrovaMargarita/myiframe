<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom UI: Basic HTML example</title>
</head>
<body>
    <h1>Hello from Custom UI</h1>
    
    <form id="dealForm">
        <label for="firstName">First:</label>
        <input type="text" id="firstName" name="firstName" required><br><br>
        <label for="lastName">Last:</label>
        <input type="text" id="lastName" name="lastName" required><br><br>
        <button type="button" id="updateDealButton">Update Deal</button>
    </form>

    <button id="myButton">Close</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0.2.0-rc.0/dist/index.umd.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const companyDomain = 'testrita-sandbox';
            const apiToken = '2fa5095f3ba3911496e097a4cfde2f150e097539';
            const baseUrl = `https://${companyDomain}.pipedrive.com/api/v1`;

            setTimeout(async () => {
                try {
                    const sdk = await new AppExtensionsSdk().initialize({ size: { height: 500, width: 500 } });
                    console.log('SDK initialized:', sdk);

                    async function createOrUpdateDeal(firstName, lastName) {
                        try {
                            const dealId = 1;

                            const fieldsResponse = await axios.get(`${baseUrl}/dealFields`, {
                                params: {
                                    api_token: apiToken
                                }
                            });

                            const dealFields = fieldsResponse.data.data;
                            console.log('All fields: ', dealFields);

                            const firstNameField = dealFields.find(field => field.name === 'First Name');
                            const lastNameField = dealFields.find(field => field.name === 'Last Name');
                            console.log(firstNameField, lastNameField);

                            const updateData = {
                                title: 'Updated Deal with Custom Fields',
                                [firstNameField.key]: firstName,
                                [lastNameField.key]: lastName
                            };

                            const updatedDealResponse = await axios.put(`${baseUrl}/deals/${dealId}`, updateData, {
                                params: {
                                    api_token: apiToken
                                },
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });

                            console.log('Deal updated:', updatedDealResponse.data);
                        } catch (err) {
                            console.error('Deal update failed:', err);
                        }
                    }

                    document.getElementById('updateDealButton').addEventListener('click', () => {
                        const firstName = document.getElementById('firstName').value;
                        const lastName = document.getElementById('lastName').value;
                        createOrUpdateDeal(firstName, lastName);
                    });

                    document.getElementById('myButton').addEventListener('click', async () => {
                        try {
                            await sdk.execute(AppExtensionsSdk.Command.CLOSE_MODAL);
                            console.log("Modal closed successfully");
                        } catch (error) {
                            console.error("Failed to close modal:", error);
                        }
                    });
                } catch (error) {
                    console.error('SDK initialization failed:', error);
                }
            }, 5000);
        });
    </script>
</body>
</html>
